---
timezone: UTC+8
---

> 请在上边的 timezone 添加你的当地时区（UTC），这会有助于你的打卡状态的自动化更新，如果没有添加，默认为北京时间 UTC+8 时区


# Echo

1. 自我介绍
    菜鸟级 dapp 开发选手，希望通过这次 EPF 的学习能够加深对以太坊的了解
2. 你认为你会完成本次残酷学习吗？
    会
3. 你的联系方式（推荐 Telegram）
    @Echo_2333


<!-- Content_START -->

## 2025.06.16

### 一、前置信息介绍
1. 以太坊 The Merge（合并）是以太坊历史上最重要的升级之一，于 2022 年 9 月 15 日成功完成。它的核心内容是将以太坊主网（执行层，原本基于工作量证明 PoW）与信标链（共识层，基于权益证明 PoS）合并，正式将以太坊的共识机制从 PoW 切换为 PoS。
    - **简单流程：**
        - 信标链（Beacon Chain）于 2020 年 12 月上线，作为 PoS 共识层并行运行。
        - 2022 年 9 月 15 日，主网与信标链合并，PoW 被永久关闭，PoS 成为唯一共识机制。
2. Geth 属于执行层客户端，负责交易的执行、状态和数据的维护，使用 Go 语言开发，是公认的最稳定、久经考验的客户端

### 二、Geth 框架的整理

Geth 从逻辑上可以分为 6 个部分：

- EVM：负责执行交易，交易执行也是修改状态数的唯一方式
- 存储：负责 state 以及区块等数据的存储
- 交易池：用于用户提交的交易，暂时存储，并且会通过 p2p 网络在不同节点之间传播
- p2p 网络：用于发现节点、同步交易、下载区块等等功能
- RPC 服务：提供访问节点的能力，比如用户向节点发送交易，共识层和执行层之间的交互
- BlockChain：负责管理以太坊的区块链数据

[![2025-06-16-18-31-01.jpg](https://i.postimg.cc/hvWk5md7/2025-06-16-18-31-01.jpg)](https://postimg.cc/G8KgBHzc)

- 如果以一个抽象的维度来看以太坊的执行层，以太坊作为一台世界计算机，需要包括三个部分，网络、计算和存储，那么以太坊执行层中与这三个部分相对应的组件是：
    - 网络：devp2p
        - 以太坊本质还是一个分布式系统，每个节点通过 p2p 网络与其他节点相连。以太坊中的 p2p 网络协议的实现就是 devp2p。
        - devp2p 有两个核心功能，一个是节点发现，让节点在接入网络时能够与其他节点建立联系；另一个是数据传输服务，在与其他节点建立联系之后，就可以想换交换数据。
    - 计算：EVM
    - 存储：ethdb

#### Geth 完整模块：
1. **账户与加密相关**
    - **accounts**：管理以太坊账户，包括公私钥对的生成、签名验证、地址派生等
    - **crypto**：加密算法（椭圆曲线、哈希、签名验证）
    - **signer**：交易签名管理（含硬件钱包）

2. **共识与信标链**
    - **beacon**：处理与以太坊信标链（Beacon Chain）的交互逻辑，PoS共识相关
    - **consensus**：共识引擎（PoW、PoS、Clique 等）
    - **miner**：挖矿逻辑（PoW 场景）

3. **区块链核心与数据结构**
    - **core**：区块链核心逻辑，处理区块/交易生命周期、状态机、Gas 计算
    - **trie & triedb**：默克尔帕特里夏树，实现账户/合约状态存储
    - **ethdb**：数据库抽象层（LevelDB、内存等）
    - **rlp**：RLP 序列化协议实现

4. **网络与节点服务**
    - **eth**：以太坊协议实现，节点服务、区块同步、交易广播
    - **p2p**：点对点网络协议，节点发现、数据传输
    - **node**：节点服务管理，整合各模块
    - **ethstats**：节点状态上报与监控
    - **event**：事件订阅与发布机制

5. **接口与交互**
    - **cmd**：命令行工具入口
    - **console**：交互式 JavaScript 控制台
    - **rpc**：JSON-RPC 和 IPC 接口
    - **graphql**：GraphQL 接口
    - **ethclient**：Go 客户端库，封装 RPC 接口
    - **RPC服务**（见 rpc/ethclient/console 等）

6. **工具与通用组件**
    - **common**：通用工具类（字节处理、地址转换、数学函数等）
    - **params**：网络参数（主网、测试网、创世块等）
    - **log**：日志系统
    - **metrics**：性能指标收集（Prometheus 支持）
    - **internal**：内部工具/限制外部访问代码

7. **构建、文档与测试**
    - **build**：构建脚本、编译配置
    - **docs**：文档
    - **tests**：集成测试、状态测试

所以本次共学主要围绕 `core`、`eth`、`ethdb`、`node`、`p2p`、`rlp`、`trie` & `triedb` 部分进行源码学习


### 三、Geth 启动

Geth 教程：[https://geth.ethereum.org/docs/getting-started](https://geth.ethereum.org/docs/getting-started) （未维护？很多页面都无法访问）

- 在 Geth 中创建账户的方法有很多种。在本次学习中尝试使用了 Clef 来创建账户，它将用户的密钥管理与 Geth 解耦，使其更加模块化和灵活。
    ``` bash
    # 老版本：
    geth --datadir . account new

    # 新版本：
    clef newaccount --keystore geth-tutorial/keystore
    ```
- 在 geth 启动的过程中 Clef 终端应保持运行。
    ``` bash
    clef --keystore geth-tutorial/keystore --configdir geth-tutorial/clef --chainid 11155111

    # --keystore 私钥存储的位置： geth-tutorial/keystore 
    # --chainid 链 ID： 11155111 为 Sepolia 测试网的链 ID
    ```
- 在 geth 终端做账户交互时需要 Clef 终端进行操作。
    ``` bash
    # geth 终端
    > eth.accounts;

    # clef 终端
    -------- List Account request--------------
    A request has been made to list all accounts. 
    You can select which accounts the caller can see
        [x] 0x12B275ea188d8B2E368880c15A3d7d60563aF811
            URL: keystore:///Users/apple/Desktop/ethereum-protocol/geth/geth-tutorial/keystore/UTC--2025-06-16T07-42-55.120127000Z--12b275ea188d8b2e368880c15a3d7d60563af811
    -------------------------------------------
    Request context:
            NA -> ipc -> NA

    Additional HTTP header data, provided by the external caller:
            User-Agent: ""
            Origin: ""
    Approve? [y/N]:
    > y

    # geth 终端
    > ["0x12b275ea188d8b2e368880c15a3d7d60563af811"]
    ```
- 如果 Clef 审批时间过长，此请求也可能会超时

## 2025.06.17

### 以太坊 The Merge 升级笔记

#### 一、核心概念与背景

1. The Merge 的定义与意义
    - **定义**：The Merge 是以太坊从工作量证明（PoW，需要大量电力的「挖矿」系统）向权益证明（PoS，「存钱生利息」的系统）过渡的关键升级
    - **时间节点**：2022 年完成，至今已稳定运行近两年
    - **当前状态**：在稳定性、性能和避免中心化风险方面表现优异

2. 升级后的核心挑战
    - **技术特性改进**：稳定性、性能和小型验证者可访问性
    - **经济变革**：应对中心化风险的经济机制调整

#### 二、关键技术改进方向

1. **单时隙最终确定性（SSF）**

    **当前问题**
    - 需要 2-3 个 epoch （约 15 分钟） 完成区块最终确定（等太久）
    - 32 ETH 的质押门槛限制了验证者参与（太贵了）

    **解决方案对比**
    - 方案 A：超级计算机快速签名（暴力破解 SSF）
    - 方案 B：抽签选代表投票（Orbit SSF）
    - 方案 C：分 VIP 和普通用户（有双层质押机制的 SSF）

        | 方案 | 验证者数量 | 最终性时间 | 实现难度 | 优势 | 劣势 |
        |------|------------|------------|----------|------|------|
        | 现状 | ~30 万 | 15 分钟 | 低 | 稳定 | 效率低 |
        | 蛮力破解 | 100 万+ | 单时隙 | 极高 | 安全性最高 | 技术复杂 |
        | Orbit 委员会 | 8k-32k | 单时隙 | 中 | 平衡性好 | 安全性略降 |
        | 双层质押 | 分层 | 单时隙 | 中 | 门槛低 | 中心化风险 |

    **技术细节**
    - **Orbit 机制**：利用验证者存款规模异质性，通过中型随机委员会实现高效最终性
    - **签名聚合**：使用 ZK-SNARKs 等技术处理大规模验证者签名

2. **单一秘密领袖选举（SSLE）**

    **当前问题**
    - 现在大家都知道下一个出块的是谁 → 容易被黑客攻击

    **解决方案**
    - 像抽盲盒，只有中奖的人自己知道身份
        - **盲验证者 ID**：通过加密技术隐藏实际验证者身份
        - **混合网络机制**：对盲 ID 池进行改组和重新盲化


3. **更快的交易确认**

    **优化方向**
    1. **缩短时隙时间**：从 12 秒降至 4-8 秒
    2. **提议者预确认机制**：
        - 实时交易纳入与确认
        - 冲突处理方案：
            - 罚没提议者
            - 证明人投票选择

    **技术权衡**
    | 方案 | 平均确认时间 | 最坏情况 | 实现难度 |
    |------|--------------|----------|----------|
    | 缩短时隙 | 显著改善 | 仍受限于网络延迟 | 高 |
    | 预确认 | 0.5 秒（理想） | 12 秒（提议者离线） | 中 |

### 三、其他重要研究领域

1. **51% 攻击恢复机制**
    - **现状**：依赖社会共识（少数派软分叉）
    - **改进方向**：自动化恢复流程
        - 客户端自动检测长期被审查交易
        - 拒绝接受恶意链为有效链

2. **投票阈值提升**
    - **当前**：67% 质押者支持即最终确定
    - **提案**：提升至 80% 阈值
        - 减少「错误方获胜」情况
        - 增强独立质押者话语权

3. **抗量子攻击**
    - **威胁时间表**：预计 21 世纪 30 年代量子计算机可能破解现有密码学
    - **应对策略**：
        - 开发基于哈希的抗量子替代方案
        - 减少对 BLS 签名聚合的依赖

### 四、技术实现路径分析

1. **单时隙最终性实现路线**
    [![1.png](https://i.postimg.cc/Y96v2wzK/1.png)](https://postimg.cc/gX0z4Q7N)
2. **关键研究链接**
    1. [单时隙最终确定性路径](https://notes.ethereum.org/@vbuterin/single_slot_finality)
    2. [Orbit SSF 提案](https://ethresear.ch/t/orbit-ssf-solo-staking-friendly-validator-set-management-for-ssf/19928)
    3. [Whisk SSLE 协议](https://ethresear.ch/t/whisk-a-practical-shuffle-based-ssle-protocol-for-ethereum/11763)

### 五、为什么这些很重要？

| 好处 | 对你有什么影响 |
|------|----------------|
| 更快确认 | 转账不用等半天 |
| 降低门槛 | 存1个ETH也能当验证人 |
| 更安全 | 不怕大户操纵价格 |
| 更环保 | 减少 99% 能源消耗 🌱 |

### 六、举个生活例子 🌈

想象以太坊是个小区：
- **以前**：物业费交给挖矿最猛的人（电费超贵）
- **现在**：业主投票选物业（存ETH多的票多）
- **问题**：富人话语权太大，穷人参与难
- **改进**：
  - 让投票更快（不用开几天业主大会）
  - 隐藏投票顺序（防打击报复）
  - 降低参与门槛（小户型也能投票）

### 七、未来会怎样？ 🚀
- 2024 年：测试快速确认功能
- 2025 年：可能实现 1 ETH 就能质押
- 2030 年：防御量子计算机攻击


## 2025.06.18

### 以太坊协议 The Surge 学习笔记

### 一、基础概念理解

#### 1. 什么是以太坊的「The Surge」？
「The Surge」是以太坊 2023 年路线图中的重要部分，主要关注 **可扩展性（scalability）** 的提升。简单来说，就是让以太坊网络能够处理更多的交易，同时保持去中心化和安全性。



#### 2. 为什么需要扩展？
目前以太坊主网（L1）每秒只能处理约 15-30 笔交易，当网络拥堵时，交易费用（Gas费）会变得很高。The Surge 的目标是实现 **L1 + L2 上 100,000+ 的 TPS**（每秒交易数）。

### 二、 核心扩展策略

#### 1. 以 Rollup 为中心的路线图
以太坊采用「分层」架构：
- **L1（主网）**：保持去中心化和安全性
- **L2（二层网络）**：负责扩展，处理大量交易

这种分工类似于：
- 法院系统（L1）保护契约和产权
- 企业家（L2）在坚固基础上构建创新应用

#### 2. 可扩展性三难困境
这是一个重要概念，指区块链难以同时实现三个理想属性：
- **去中心化**：运行节点的成本低
- **可扩展性**：处理高交易量的能力
- **安全性**：攻击成本高

### 三、关键技术方案

#### 1. 数据可用性采样（DAS）
**解决的问题**：验证大量数据而不需要下载全部数据

**当前状态**：
- 每个时隙（12秒）有 3 个约 125kB 的「blob」
- 最大 TPS 约 173.6（仅 blob）或 607（加上 calldata）

**未来目标**：
- 通过 PeerDAS 将 blob 数量增加到 8-16 个
- 中期目标：每时隙 16 MB，约 58,000 TPS

#### 2. 数据压缩
**为什么需要**：减少每笔交易在链上占用的空间

**优化方法**：
1. 零字节压缩
2. 签名聚合（从 ECDSA 迁移到 BLS）
3. 地址指针替换（用 4 字节代替 20 字节地址）
4. 交易金额自定义序列化

#### 3. Plasma 架构
**与 Rollup 的区别**：
- Rollup：将完整区块数据上链
- Plasma：只在链上记录区块 Merkle 根

**优势**：
- 更高的扩展性
- 用户即使数据不可用也能提取资产

#### 4. L2 证明系统成熟化
**当前问题**：大多数 Rollup 尚未完全无信任

**发展阶段**：
- 阶段 0：中心化或基于信任的验证
- 阶段 1：无信任证明机制 + 安全委员会
- 阶段 2：完全无信任证明机制（目标）



### 四、跨 L2 互操作性改进

#### 1. 当前问题
不同 L2 间切换困难，用户体验差

#### 2. 解决方案方向
1. **链特定地址**：地址包含链标识
2. **链特定支付请求**：标准化跨链支付请求
3. **跨链兑换与 gas 支付**：标准化协议
4. **轻客户端**：直接验证交互的链
5. **密钥库钱包**：密钥集中管理

### 五、L1 上的扩展执行

#### 1。 为什么需要扩展 L1？
即使 L2 很成功，L1 仍需保持足够能力：
- 维护 ETH 资产价值
- 支持 L2 故障恢复
- 保持与 L2 生态的紧密联系

#### 2. 扩展策略
1. **直接增加 gas 上限**：需配合验证技术改进
2. **优化特定功能**：
   - EOF 新字节码格式
   - 多维 gas 定价
   - 降低特定操作码成本
3. **原生 Rollup**：协议内建并行 EVM

### 六、关键学习要点

1. 以太坊采用分层扩展策略，L1 保持安全，L2 负责扩展
2. 数据可用性采样是扩展的基础技术
3. Plasma 和 Rollup 是两种主要扩展方案，各有优劣
4. L2 需要逐步实现完全无信任的证明机制
5. 跨链互操作性是提升用户体验的关键
6. L1 自身也需要持续扩展

### 七、未来展望

The Surge 路线图的实现将使以太坊能够支持大规模应用，如：
- 消费支付
- 去中心化社交网络
- 高吞吐量 DApps

同时保持以太坊核心的去中心化和安全特性。

## 2025.6.19
### **学习总结：以太坊核心开发进展（Checkpoint #4: Berlinterop）**  

#### **1. 背景**  
以太坊核心开发者每周会议（All Core Developer calls）内容繁多，本系列“Checkpoint”旨在提供高层级更新。本次是特别版，聚焦柏林区块链周期间的**Berlinterop**（开发者协作周），重点包括：  
- **短期目标**：Fusaka 升级、Gas Limit 提升  
- **长期研究方向**：Slot 结构调整、历史数据清理（History Expiry）等  
- **L2 与 ZK 团队反馈**：优化 L1 与 L2 的协作  

---  

#### **2. 短期进展**  
**（1）Fusaka 升级**  
- 开发者启动了测试网：`fusaka-devnet-1` 和 `berlinterop-devnet-2`。  
- 发现需改进点，但需通过 ACD（All Core Developers）治理流程确认（本周四讨论）。  
- 乐观估计：夏季末推进至**Sepolia 测试网**，可能无需`devnet-3`。  

**（2）Gas Limit 提升**  
- 目标：安全提高网络吞吐量（如 4500 万 Gas/区块）。  
- 开发者通过压力测试挑战赛（Leaderboard）验证方案，Kamil 和 pk910 表现突出。  
- 共识达成后，优化方案将通过 **EthPandaOps 推特**和 **Eth R&D Discord** 发布。  

---  

#### **3. 长期研究方向**  
**（1）Slot 结构调整**  
- 讨论缩短 Slot 时间或调整子 Slot 时序，涉及提案：  
  - **ePBS**（提议者-构建者分离）  
  - **Delayed Execution**（延迟执行）  
  - **FOCIL**（快速确认）  
- **优势**：减少数据延迟、降低大区块影响、增强抗审查性。  
- 下一步：合并相关 PR，规范客户端验证逻辑。  

**（2）历史数据清理（History Expiry）**  
- 进展顺利！主网将默认清理合并前的历史数据（🎉）。  
- 已就 **Era 文件标准**达成一致，未来两个月将公布：  
  - 滚动清理机制  
  - 数据分发方案  
- 本周五召开社区会议讨论 **Portal 网络**的未来。  

**（3）共识层（CL）加固**  
- 针对 Holešky 分叉等问题，提出 26 项改进（如非最终状态同步、资源优化等）。  
- 目标：提升网络在非最终性期间的稳定性。  

---  

#### **4. L2 与 ZK 团队反馈**  
**（1）L2 日**  
- **需求**：更多 Blob 空间、更快最终性、EVM 变更提前沟通（如 calldata 定价）。  
- **协作建议**：L2 可分享高吞吐量网络经验，助力 L1 扩展设计。  

**（2）ZK 日**  
- **共识**：暂不固化特定 ISA（指令集架构），优先支持 RISC-V 目标。  
- **标准化**：统一系统调用和 Rust 库，300KB 证明大小合理。  
- **目标**：年底前实现 ZK 无状态客户端（基于 Reth）。  

---  

#### **5. 总结**  
- **Berlinterop 成果显著**：打破异步沟通壁垒，加速了长期停滞的项目。  
- **Fusaka 升级有望 2025 年落地**，Gas Limit 提升和 L2/ZK 协作是关键推动力。  
- **下一步**：关注 ACD 会议决议、Portal 网络讨论和 Ethereum/pm 仓库的详细笔记。  

---  
**延伸阅读**：  
- [以太坊基金会](https://ethereum.org) | [R&D Discord](https://discord.gg/ethereum)  
- 相关会议记录将发布于 [ethereum/pm GitHub](https://github.com/ethereum/pm)。

## 2025.6.20

复习：https://mp.weixin.qq.com/s?__biz=MzI2NzExNTczMw==&mid=2653293546&idx=1&sn=4170dca0fac69556c3e46539867bfeb7&scene=21#wechat_redirect
粗略阅读：https://mp.weixin.qq.com/s?__biz=MzI2NzExNTczMw==&mid=2653293588&idx=1&sn=c9ef3a890934cbbc9a4a6f78407aef03&scene=21&poc_token=HI08VWijAuA_s6L9LhUoc4-991C418FiI0HrQTgy

### 修正区块构建流程

1. 要解决什么问题？
    
    目前，主要通过额外的提议者-构建者协议（MEVBoost）来完成。当验证者有机会提出区块时，他们会将选择区块内容的任务拍卖给称为构建者的专业参与者。
    
    选择能将收入最大化的区块内容的任务非常依赖规模经济：需要专门的算法来确定应包括哪些交易，以便从链上金融工具和用户的相关交易中提取尽可能多的价值（这就是所谓的“MEV 提取”）。验证者则只需承担相对规模经济较小的"dumb pipe" 任务，即监听出价并接受最高出价，同时也需履行其他职责，比如验证。

### 修正质押经济学

### 应用层解决方案



## 2025.06.21

### **学习笔记：以太坊的「The Scourge」是什么？**
#### **核心问题**
1. **中心化风险**  
   - **区块构建中心化**：88% 的区块由少数专业构建者（Builder）控制，可能审查交易或操纵 MEV（如三明治攻击）。
   - **质押中心化**：大型质押池（如 Lido）主导网络，小型质押者退出，威胁去中心化和安全。

2. **价值提取风险**  
   - MEV（矿工可提取价值）被少数人捕获，用户被迫支付更高 Gas 费或承受滑点损失。

---

#### **三大解决方案**
##### 1. 修正区块构建流程（解决构建者垄断）
- **包含列表（Inclusion List）**  
  - 随机选出的质押者创建「必须包含的交易列表」，构建者只能排序和添加交易，无法完全控制内容。
- **FOCIL「分叉选择强制包含列表」 + APS「验证者-提议者分离」**  
  - 委员会强制包含交易 + 拍卖区块构建权，降低审查可能性（需所有委员串谋才能延迟交易）。
- **BRAID（多个并行提议者 MCP 方案）**  
  多个提议者提交交易，按手续费排序，减少单个构建者权力（需配合**加密内存池**防抢跑）。

##### 2. 修正质押经济学（解决质押垄断）
- **减少 ETH 发行量**  
  - 若质押比例过高（如 >30%），降低新 ETH 发行，减少经济激励避免「全员质押」。
- **双层质押模型**  
  - **风险层**：少数人承担罚没风险，获取高收益（上限为总 ETH 的 1/8）。  
  - **无风险层**：大众参与质押，收益稳定但较低。
- **MEV Burn（燃烧 MEV）**  
  - 通过协议捕获 MEV 收入并销毁，减少质押暴利，平衡收益。

##### 3. 应用层辅助方案
- **硬件简化**：Dappnode 等提供「一键质押」设备，降低节点运行门槛。
- **小队质押（Obol）**：多人合作质押（如 3/5 签名），分担成本与风险。
- **去中心化区块构建**：用 ZK、TEE 技术构建抗审查的区块市场。
- **应用设计优化**：如 CowSwap 链下撮合交易，减少链上 MEV 泄露。

---

### **为什么这些重要？**
- **用户角度**：减少被 MEV 剥削，交易更便宜快速。
- **网络健康**：防止巨头垄断，保持以太坊「抗审查」「去中心化」的核心价值。
- **质押者**：小型质押者也能公平获利，无需依赖中心化池。

> 🔗 **延伸学习**：  
> - MEV科普：[https://www.learnmev.com/](https://www.learnmev.com/)  
> - 质押经济模型：[issuance.wtf](https://issuance.wtf/)  
> - Obol小队质押：[obol.tech](https://www.obol.tech/)

## 2025.06.22

请假

## 2025.06.23

### **The Verge 核心目标**
**愿景**：让低资源设备（如手机、智能手表）也能运行**完全验证节点**，实现以太坊的去中心化验证。
- **关键技术**：无状态验证 + EVM 执行有效性证明 + 共识有效性证明
- **效果**：节点无需存储完整状态，通过小型证明（如 SNARK/STARK）即可验证区块。

---

### **一、无状态验证：Verkle 树 vs STARKed 哈希树**
#### **问题**
- 当前 **Merkle Patricia 树（MPT）** 的缺陷：
  - 十六叉树结构导致证明体积大（最坏情况 330MB）。
  - 代码未默克尔化，访问需提供完整代码（24KB/账户）。
- 状态数据增长（年增约 30GB）阻碍轻量设备运行节点。

#### **解决方案**
1. **Verkle 树**（基于椭圆曲线向量承诺）
   - **优势**：
     - 证明体积小：理论最坏情况仅 1.3MB（通过`EIP-4762`优化相邻访问）。
     - 支持见证更新（对内存池、轻客户端友好）。
   - **挑战**：
     - 量子不安全，未来需替换。
     - 难以用 SNARK 压缩到千字节级。

2. **STARKed 二进制哈希树**
   - **原理**：用 STARK 证明替代传统的默克尔分支（约 100-300KB 固定开销）。
   - **优势**：
     - 量子安全（若用 Poseidon 等抗量子哈希）。
     - 状态根计算更快（降低同步时间）。
   - **挑战**：
     - 需高效证明保守哈希（如 SHA256），当前速度不足（需达 20 万哈希/秒）。
     - Poseidon 哈希安全性需更多验证。

#### **权衡与待解决问题**
| **方案**          | 证明体积 | 量子安全 | 证明更新 | 实现难度 |
|-------------------|----------|----------|----------|----------|
| Verkle 树          | 低       | ❌        | ✅        | 低（代码成熟） |
| STARKed 哈希树     | 极低     | ✅        | ❌        | 高       |
- **优化方向**：
  - 多维 Gas 模型（分离状态访问/计算/存储限制）。
  - 延迟状态根计算（换取证明时间）。
  - 过渡方案分析（如`EIP-4762`的 Gas 成本调整）。

---

### **二、EVM执 行的有效性证明**
#### **目标**
用户仅下载区块片段 + 小型证明即可验证 EVM 执行正确性。

#### **挑战**
1. **安全性**：
   - 需形式化验证（如基于 EVM K 语义）或多验证者机制。
2. **验证时间**：
   - 当前需 15 秒（并行 GPU），目标为 4 秒内。

#### **优化路径**
1. **递归证明聚合**：
   - 按操作码拆分证明，构建聚合树（O(log N)时间）。
2. **证明系统升级**：
   - 采用 Binius、GKR 等新系统加速。
3. **EVM 改造**：
   - **Gas 成本调整**（如`EIP-7667`提高哈希操作 Gas）。
   - **数据结构替换**：交易/收据树迁移至 SSZ 格式。

#### **权衡**
- **去中心化 vs 速度**：是否允许专用硬件生成证明？
- **兼容性**：激进优化或破坏现有合约（需重写）。

---

### **三、共识的有效性证明**
#### **问题**
验证权益证明共识（BLS 签名、SHA256 哈希、验证者状态更新）计算量大。

#### **优化方向**
1. **哈希函数替换**：
   - SHA256 → Poseidon（速度提升 100 倍）。
2. **签名聚合**：
   - 递归证明分散网络负载（如 Halo2 方案）。
3. **共识层重构**：
   - **Orbit 分片**：减少单时隙验证者数量（8K~32K）。
   - **直接存储洗牌结果**：减少默克尔分支验证。
   - **简化操作**：如用 SHA256 压缩函数替代全哈希。

#### **挑战**
- BLS12-381 操作证明慢（缺乏高效曲线）。
- 需增量可验证计算优化状态读取。

#### **时间线**
- 与最终确定性、Orbit、签名方案升级协同推进，预计需数年落地。

---

### **路线图协同效应**
1. **无状态验证** → 降低单独质押门槛（结合 Orbit SSF）。
2. **EOF/EIP-7701** → 简化多维 Gas 模型。
3. **EIP-4444** → 历史数据过期，减少存储负担。
4. **Layer2 ZK-Rollup** → 共享 L1 有效性证明技术。

---

### **关键结论**
- **短期**：Verkle 树最可能优先部署（代码成熟）。
- **长期**：STARKed 哈希树 + EVM/共识证明是终极方向。
- **核心价值**：**手机级设备完全验证以太坊**将重塑去中心化生态。

> 延展阅读：  
> - [Verkle树详解](https://verkle.info/)  
> - [EIP-4762: 无状态Gas模型](https://eips.ethereum.org/EIPS/eip-4762)  
> - [ZK-EVM形式化验证](https://verified-zkevm.org/)  

## 2025.06.24

### The Purge 学习笔记


### **一、核心目标：解决协议膨胀与复杂度**
| **问题领域**       | **现状与挑战**                                                                 | **解决方案方向**                     |
|--------------------|-------------------------------------------------------------------------------|-------------------------------------|
| **历史数据膨胀**   | 节点需永久存储完整历史数据（ >1.1 TB），同步时间持续增加                          | EIP-4444 引入存储期限 + P2P 分布式存储 |
| **状态数据增长**   | 状态数据每年增长约 50 GB，用户一次性操作导致永久存储负担                         | 局部状态过期（如 EIP-7736）或地址周期方案 |
| **协议复杂度累积** | 新增功能易，移除旧功能难，代码复杂度持续升高（如 RLP 编码、预编译合约）           | 特性清理（移除冗余功能，统一标准）   |

---

### **二、关键技术方案详解**
#### **1. 历史过期（History Expiry）**
- **核心机制**：
  - **EIP-4444**：设定历史数据存储期限（约 1 年），超期数据由分布式网络（如 Portal Network）存储。
  - **纠删码技术**：复制因子不变下提升数据鲁棒性（Blobs 已应用）。

    > 鲁棒性：指一个系统在异常输入、意外环境或部分故障情况下仍能保持核心功能正常运作的能力。其核心是抗干扰性和容错能力。  

- **实现路径**：
  - 短期：整合 Torrent 或 Portal Network 实现分布式存储。
  - 长期：节点仅存储近期数据，上古历史依赖去中心化网络。
- **权衡点**：上古历史可用性保障（需托管证明 vs 自愿存储标准）。

#### **2. 状态过期（State Expiry）**
- **两类方案对比**：
  | **方案类型**       | **代表提案**    | **工作原理**                                                                 | **优缺点**                                                                 |
  |-------------------|---------------|-----------------------------------------------------------------------------|---------------------------------------------------------------------------|
  | **局部状态过期**   | EIP-7736      | 按“茎”（stem）分组状态数据，6 个月未访问则替换为 32 字节存根，激活需提供证明      | ✅ 兼容无状态化<br>❌ 永久存储存根（仍增长）                                |
  | **地址周期方案**   | 地址空间扩展   | 状态树分周期冻结，地址含周期号（需扩展至 32 字节），访问旧状态需证明并迁移至新周期 | ✅ 完全消除存储增长<br>❌ 地址格式兼容性风险（碰撞攻击成本降至 2⁵⁶）          |

- **关键挑战**：
  - **地址空间扩展**：32 字节地址需解决向后兼容（如旧合约的 20 字节地址假设）。
  - **碰撞风险**：地址空间收缩方案（14 字节哈希）可能引发安全漏洞。

#### **3. 特性清理（Feature Cleanup）**
- **重点优化方向**：
  | **类别**           | **待清理项**                | **替代方案**                                | **进展**                          |
  |--------------------|---------------------------|-------------------------------------------|-----------------------------------|
  | **数据编码**       | RLP 序列化                  | 统一为 SSZ（强类型化，支持哈希）             | EIP-6493/6465/6466 推进中          |
  | **交易类型**       | 旧交易格式（如 Legacy TX）  | 账户抽象（AA）统一处理逻辑                 | 纳入长期路线图                    |
  | **预编译合约**     | 低使用率合约（RIPEMD 等）   | 移除或用 EVM 代码替代                        | 根身份预编译草案提出              |
  | **EVM 机制**        | 动态跳转、gas 可观察性      | EOF（EVM 对象格式）强制静态跳转、隐藏 gas     | EOF 提案中                        |
  | **共识层**         | 同步委员会、信标链委员会   | SNARK 验证替代同步委员会，分片完成后移除委员会 | 同步委员会已标记为过渡性功能      |

- **简化流程**：
[![1.png](https://i.postimg.cc/hvq7Lf94/1.png)](https://postimg.cc/bD3J8YC4)

---

### **三、关键权衡与未决问题**
- **历史过期**：分布式存储的鲁棒性 vs 中心化归档依赖风险。
- **状态过期**：存储增长速率 vs 地址兼容性安全。
- **特性清理**：协议简洁性 vs 向后兼容性（如 `SELFDESTRUCT` 移除耗时多年）。
- **核心矛盾**：**永久性承诺**（区块链本质）与 **可持续发展**（降低节点负担）的平衡。

---

### **四、与其他路线图的协同**
1. **无状态化（The Verge）**  
   - 状态过期可降低验证者存储压力，与无状态验证互补。
2. **账户抽象（Account Abstraction）**  
   - 特性清理后，旧交易逻辑可由 AA 合约统一处理。
3. **数据分片（The Surge）**  
   - Blobs 纠删码技术可直接复用于历史数据存储。

---

### **五、开发者启示**
1. **前瞻性开发**：
   - 避免依赖可能被清理的功能（如旧预编译合约）。
   - 采用 SSZ 编码、EOF 格式等新标准设计合约。
2. **状态管理**：
   - 应用需设计状态自动续期机制（如定期访问关键状态）。
   - 反事实地址避免使用高危地址段（防碰撞攻击）。

> 本文技术深度较高，建议结合EIP文档（如 [EIP-4444](https://eips.ethereum.org/EIPS/eip-4444)、[EIP-7736](https://eips.ethereum.org/EIPS/eip-7736)）进一步研究。

## 2025.06.25

### 🧱 模块 1：以太坊区块处理全流程

> 🔍 目标：从“发送交易”到“交易被打包进区块并完成状态更新”的完整底层流程。


## 🧭 分层结构预览（类比导入）

可以将以太坊想象成一个分工明确的“数字城市”：

* 👥 **用户层**：你提交了一个交易（比如转账 or 调用合约）
* 📦 **交易池（mempool）**：像快递仓库，等待被“快递员”打包
* 🧠 **执行层（EVM）**：处理交易、计算状态变化
* 🏛️ **共识层**：判断这批交易打包是否有效，并“盖章生效”
* 📜 **最终状态**：城市账本被更新，完成一次“合法的改变”

---

## 🧾 全流程拆解（逐步展开）

### 第 1 步：交易广播（Transaction Broadcast）

你调用了一个钱包（比如 MetaMask）：

```txt
你 -> 钱包 -> 签名交易 -> 发往 P2P 网络
```

* 交易被打包成结构体，包含：

  * `from`, `to`, `value`, `gas`, `data`, `nonce`, `signature`
* 广播到本地节点，进入内存池（mempool）

📌 **内存池类比：** 像未发货的快递集散中心，矿工/验证者会从中挑选交易。

---

### 第 2 步：区块构建（Block Construction）

> 🚨 当前以太坊是 PoS 模式，所以每个 slot 会随机选出一个 proposer 提议区块

* proposer 从 mempool 中挑选 gas fee 高的交易（以获得更多 MEV）
* 构建区块头（包含 parentHash、stateRoot、transactionsRoot 等）
* 填充交易数据，构成区块体（body）

📌 **类比：** 像记者写新闻稿，要引用前一条新闻（parent block），并记录当前内容的摘要（Merkle 根）。

---

### 第 3 步：EVM 执行交易（状态转移）

每笔交易都由 EVM 执行：

```
Apply(State, Tx) => State'
```

* EVM 读取合约字节码
* 在 sandbox 环境中模拟执行
* 每次 SLOAD/SSTORE 操作都会影响状态树（state trie）
* 如果交易失败（比如 Revert），状态回滚，但仍消耗 gas

📌 **类比：** EVM 像一台能执行智能程序的“模拟机”，状态更新像修改城市的账本。

---

### 第 4 步：生成区块状态根（stateRoot）

* 所有交易执行完后：

  * 更新全局状态树（State Trie）
  * 计算出新的 `stateRoot`
  * 写入区块头

📌 **Merkle-Patricia Trie** 是一种可验证的状态结构，它允许通过根哈希验证所有账户状态。

---

### 第 5 步：区块广播与共识验证

* proposer 将区块广播到网络
* 其他验证者执行同样的交易序列、确认 `stateRoot` 是否一致
* 若达成共识：

  * 该区块被视为“已终结”（finalized）

---

### 第 6 步：链上状态更新 + 用户感知

* 区块被确认后：

  * 钱包显示余额变动
  * 合约状态同步更新
  * 链上事件（logs）被前端监听

---

## ✅ 关键概念回顾

| 阶段   | 关键术语                 | 类比说明         |
| ---- | -------------------- | ------------ |
| 广播交易 | Mempool              | 快递仓库等待发货     |
| 构建区块 | 区块头、交易列表             | 报纸结构、新闻内容    |
| 执行交易 | EVM、状态转移             | 程序运行、账本变更    |
| 状态树  | Merkle-Patricia Trie | 权威总账，支持可验证查询 |
| 广播区块 | Slot、验证者签名           | 投票表决盖章       |
| 用户反馈 | Logs、Events、前端监听     | 界面反馈变更       |

---

## 📚 示例小测验（理解检查）

下面这些问题可以帮助你自检：

### ✅ 问题一：为什么 gas 机制对于以太坊交易排序如此重要？

#### 💡答案简述：

**Gas 决定谁优先执行交易。**

#### 🔍技术解释：

每笔交易会附带一个 `gasPrice` 或 `maxFeePerGas`（EIP-1559 后的新机制）。区块 proposer（提议者）会优先选择那些愿意支付**更高 gas 费**的交易打包进区块。

* gas 就像“交易执行的燃料”
* gas price 是“你愿意每单位燃料付多少钱”

> ✅ 所以越高的 gas price 意味着越高的**优先级**。

#### 🧠类比说明：

像打车平台滴滴拼车，**谁出价高**，司机就**优先接单**。

---

### ✅ 问题二：什么是状态树（state trie）？为什么它需要 Merkle 结构？

#### 💡答案简述：

**状态树是记录账户/合约状态的“可验证账本”，Merkle 结构能高效验证局部状态。**

#### 🔍技术解释：

以太坊所有账户、合约的状态（余额、nonce、代码哈希、存储等）都被存储在一棵**Merkle-Patricia Trie**里。

* “Merkle”结构：每个子节点哈希拼接形成上层节点哈希，最终得出 `stateRoot`
* “Patricia”结构：键值前缀压缩，使得路径更短，效率更高

验证者只需要 `stateRoot`，就能验证：

> “某账户状态是否在全局状态树中存在且正确？”

#### 🧠类比说明：

像你银行提供一份“全行资产哈希摘要”，你可以通过部分收据验证“你的存款确实被记录”，而无需查看所有人的数据。

---

### ✅ 问题三：EVM 如何处理一笔失败的交易？它是否影响全局状态？

#### 💡答案简述：

**失败的交易会回滚状态变化，但仍然扣除 gas 费。**

#### 🔍技术解释：

EVM 使用事务模型：

* 在执行交易前复制当前状态为一个“沙盒环境”
* 如果合约执行出现 `revert()` 或触发异常：

  * 所有 `SSTORE` 写入被丢弃
  * 只保留 `gasUsed`，用户仍需支付这部分手续费

> ✅ 所以，失败交易不会影响**全局状态树（stateRoot）**，但影响用户的钱包余额（因为 gas 已经花了）

#### 🧠类比说明：

像你去自动贩卖机买水，钱已经投入了（gas 消耗），但水卡住没掉下来（逻辑失败），这次“尝试”不会改变机器商品的库存（状态），但你的钱没退回（gas没退）。

---

## 🧠小结：这三点构成以太坊执行流程的核心设计目标：

| 问题     | 核心价值               |
| ------ | ------------------ |
| gas 排序 | 鼓励市场竞价，提高效率        |
| 状态树    | 保证去中心化数据的一致性和可验证性  |
| 失败交易   | 保证原子性和安全性，避免意外状态污染 |

## 2025.6.26

周会已做分享

## 2025.6.29

复习 the Merge 升级

<!-- Content_END -->
